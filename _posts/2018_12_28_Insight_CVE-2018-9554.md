---
layout: default
author: juwei lin
date: 2018-12-28 11:08:00 +0800
---

# Multiple Android Media Framework Information Disclosure Cases [INTERNAL]

## Background and Overview 
In [December Android bulletin](https://source.android.com/security/bulletin/2018-12-01.html), there is [CVE-2018-9554](https://android.googlesource.com/platform/frameworks/av/+/16f9b39c69626093ae9225b458739707c9a3b4e7). It is a vulnerability of type ID(information disclosure).  
This vulnerability is about dumping information into disk file without any permission control. Android patched this case just by adding permission check like the following:  
```
 status_t dumpExtractors(int fd, const Vector<String16>&) {
     String8 out;
-    out.append("Recent extractors, most recent first:\n");
-    {
-        Mutex::Autolock lock(sExtractorsLock);
-        for (size_t i = 0; i < sExtractors.size(); i++) {
-            const ExtractorInstance &instance = sExtractors.itemAt(i);
-            out.append("  ");
-            out.append(instance.toString());
+    const IPCThreadState* ipc = IPCThreadState::self();
+    const int pid = ipc->getCallingPid();
+    const int uid = ipc->getCallingUid();
+    if (!PermissionCache::checkPermission(String16("android.permission.DUMP"), pid, uid)) {
+        out.appendFormat("Permission Denial: "
+                "can't dump MediaExtractor from pid=%d, uid=%d\n", pid, uid);
+    } else {
+        out.append("Recent extractors, most recent first:\n");
+        {
+            Mutex::Autolock lock(sExtractorsLock);
+            for (size_t i = 0; i < sExtractors.size(); i++) {
+                const ExtractorInstance &instance = sExtractors.itemAt(i);
+                out.append("  ");
+                out.append(instance.toString());
+            }
         }
     }
```
It adds permission check for `android.permission.DUMP`.  
  
After searching the Android Media Framework source code, I found there are still multiple such kind cases. I list them in the next section.


## Multiple ID cases in Media Framework
After searching the media framework source code, I found there are 11 places calling check permission `android.permission.DUMP`:
* DrmManagerService
* IMediaExtractor
* mediaplayer2
* MediaPlayerService
* ServiceUtilities
* CameraService
* MediaAnalyticsService
* MediaLogService
* ResourceManagerService
* SoundTriggerHwService
  
After check, the following cases may not have `android.permission.DUMP` permission check before dumping information into files.

| Case No.        | Function Name          | File Name |  
|:-------------|:------------------|:------|  
|001|AudioRecord::dump|Android/frameworks/av/media/libaudioclient/AudioRecord.cpp|  
|002|AudioTrack::dump|Android/frameworks/av/media/libaudioclient/AudioTrack.cpp|
|003|JAudioTrack::dump|Android/frameworks/av/media/libmediaplayer2/JAudioTrack.cpp|
|004|StagefrightRecorder::dump|Android/frameworks/av/media/libmediaplayerservice/StagefrightRecorder.cpp|
|005|MediaExtractorFactory::dump|Android/frameworks/av/media/libstagefright/MediaExtractorFactory.cpp|
|006|MPEG4Writer::dump|Android/frameworks/av/media/libstagefright/MPEG4Writer.cpp|
|007|MPEG4Writer::Track::dump|Android/frameworks/av/media/libstagefright/MPEG4Writer.cpp|
|008|ARTPWriter::send|Android/frameworks/av/media/libstagefright/rtsp/ARTPWriter.cpp|
|009|WebmElement::write|Android/frameworks/av/media/libstagefright/webm/WebmElement.cpp|
|010|writeDescriptors|Android/frameworks/av/media/mtp/MtpDescriptors.cpp|
|011|writeToFd|Android/frameworks/av/media/mtp/MtpDevice.cpp|
|012|MtpFfsCompatHandle::writeHandle|Android/frameworks/av/media/mtp/MtpFfsCompatHandle.cpp|
|013|AudioRouteVector::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioCollections.cpp|
|014|AudioGain::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioGain.cpp|
|015|AudioInputDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioInputDescriptor.cpp|
|016|AudioInputCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioInputDescriptor.cpp|
|017|AudioOutputDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioOutputDescriptor.cpp|
|018|SwAudioOutputDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioOutputDescriptor.cpp|
|019|HwAudioOutputDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioOutputDescriptor.cpp|
|020|SwAudioOutputCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioOutputDescriptor.cpp|
|021|HwAudioOutputCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioOutputDescriptor.cpp|
|022|AudioPatch::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioPatch.cpp|
|023|AudioPatchCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioPatch.cpp|
|024|AudioPolicyMix::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioPolicyMix.cpp|
|025|AudioPolicyMixCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioPolicyMix.cpp|
|026|AudioPort::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioPort.cpp|
|027|AudioProfile::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioProfile.cpp|
|028|AudioRoute::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioRoot.cpp|
|029|AudioSession::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioSession.cpp|
|030|AudioSessionCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioSession.cpp|
|031|AudioSourceDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioSourceDescriptor.cpp|
|032|AudioSourceCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/AudioSourceDescriptor.cpp|
|033|DeviceVector::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/DeviceDescriptor.cpp|
|034|DeviceDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/DeviceDescriptor.cpp|
|035|EffectDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/EffectDescriptor.cpp|
|036|EffectDescriptorCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/EffectDescriptor.cpp|
|037|HwModule::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/HwModule.cpp|
|038|HwModuleCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/HwModule.cpp|
|039|IOProfile::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/IOProfile.cpp|
|040|StreamDescriptor::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/StreamDescriptor.cpp|
|041|StreamDescriptorCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/StreamDescriptor.cpp|
|042|VolumeCurve::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/VolumeCurve.cpp|
|043|VolumeCurvesForStream::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/VolumeCurve.cpp|
|044|VolumeCurvesCollection::dump|Android/frameworks/av/services/audiopolicy/common/managerdefinitions/src/VolumeCurve.cpp|





## Root Case Analysis
See CVE-2018-9554 description in the first section `Background and Overview`.  

## PoC
Not Provided.

## Q & A
### How did you find this vulnerability?
by code review.

### Can you identify exploitability?
These are information leak cases. They may leak sensitive system or data information.

### Can you identify root cause?
Yes, see the root cause analysis.

### Vulnerable software and hardware
Android 9 and All before.